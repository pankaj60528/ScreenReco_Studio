{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/rohit/OneDrive/Desktop/shareable-screen-studio/src/lib/db.ts"],"sourcesContent":["import fs from 'fs/promises';\r\nimport path from 'path';\r\nimport { nanoid } from 'nanoid';\r\n\r\nexport interface VideoRecord {\r\n  id: string;\r\n  title: string;\r\n  sourceUrl: string;\r\n  trimmedUrl: string;\r\n  durationSeconds: number | null;\r\n  trimStart?: number;\r\n  trimEnd?: number;\r\n  shareId: string;\r\n  viewCount: number;\r\n  completionPercent: number;\r\n  createdAt: string;\r\n}\r\n\r\ninterface StoreShape {\r\n  videos: VideoRecord[];\r\n}\r\n\r\nconst dataDir = path.join(process.cwd(), 'data');\r\nconst dataFile = path.join(dataDir, 'videos.json');\r\nconst tmpDataFile = path.join(dataDir, 'videos.json.tmp');\r\n\r\nasync function ensureStore(): Promise<StoreShape> {\r\n  await fs.mkdir(dataDir, { recursive: true });\r\n  try {\r\n    const content = await fs.readFile(dataFile, 'utf-8');\r\n    return JSON.parse(content) as StoreShape;\r\n  } catch (err: any) {\r\n    if (err?.code === 'ENOENT') {\r\n      const initial: StoreShape = { videos: [] };\r\n      await fs.writeFile(dataFile, JSON.stringify(initial, null, 2), 'utf-8');\r\n      return initial;\r\n    }\r\n    throw err;\r\n  }\r\n}\r\n\r\nasync function saveStore(store: StoreShape) {\r\n  const payload = JSON.stringify(store, null, 2);\r\n  await fs.writeFile(tmpDataFile, payload, 'utf-8');\r\n  await fs.rename(tmpDataFile, dataFile);\r\n}\r\n\r\nexport async function addVideo(params: {\r\n  title: string;\r\n  url: string;\r\n  durationSeconds?: number;\r\n  trimStart?: number;\r\n  trimEnd?: number;\r\n}): Promise<VideoRecord> {\r\n  const store = await ensureStore();\r\n  const id = nanoid(10);\r\n  const shareId = nanoid(8);\r\n  const record: VideoRecord = {\r\n    id,\r\n    title: params.title,\r\n    sourceUrl: params.url,\r\n    trimmedUrl: params.url,\r\n    durationSeconds: params.durationSeconds ?? null,\r\n    trimStart: params.trimStart,\r\n    trimEnd: params.trimEnd,\r\n    shareId,\r\n    viewCount: 0,\r\n    completionPercent: 0,\r\n    createdAt: new Date().toISOString(),\r\n  };\r\n  store.videos.push(record);\r\n  await saveStore(store);\r\n  return record;\r\n}\r\n\r\nexport async function getVideo(idOrShare: string): Promise<VideoRecord | undefined> {\r\n  const store = await ensureStore();\r\n  return store.videos.find((v) => v.id === idOrShare || v.shareId === idOrShare);\r\n}\r\n\r\n// FIX FOR ERROR 2: We name this 'getVideos'\r\nexport async function getVideos(): Promise<VideoRecord[]> {\r\n  const store = await ensureStore();\r\n  return store.videos;\r\n}\r\n\r\n// FIX FOR ERROR 1: This function was missing\r\nexport async function deleteVideo(idOrShare: string): Promise<VideoRecord | undefined> {\r\n  const store = await ensureStore();\r\n  const index = store.videos.findIndex((v) => v.id === idOrShare || v.shareId === idOrShare);\r\n  if (index === -1) return undefined;\r\n  const [removed] = store.videos.splice(index, 1);\r\n  await saveStore(store);\r\n  return removed;\r\n}\r\n\r\nexport async function incrementView(id: string): Promise<VideoRecord | undefined> {\r\n  const store = await ensureStore();\r\n  const video = store.videos.find((v) => v.id === id || v.shareId === id);\r\n  if (video) {\r\n    video.viewCount += 1;\r\n    await saveStore(store);\r\n  }\r\n  return video;\r\n}\r\n\r\nexport async function updateCompletion(id: string, completionPercent: number): Promise<VideoRecord | undefined> {\r\n  const store = await ensureStore();\r\n  const video = store.videos.find((v) => v.id === id || v.shareId === id);\r\n  if (video) {\r\n    video.completionPercent = Math.max(video.completionPercent, completionPercent);\r\n    await saveStore(store);\r\n  }\r\n  return video;\r\n}"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;AACA;AACA;;;;AAoBA,MAAM,UAAU,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI;AACzC,MAAM,WAAW,4GAAI,CAAC,IAAI,CAAC,SAAS;AACpC,MAAM,cAAc,4GAAI,CAAC,IAAI,CAAC,SAAS;AAEvC,eAAe;IACb,MAAM,gIAAE,CAAC,KAAK,CAAC,SAAS;QAAE,WAAW;IAAK;IAC1C,IAAI;QACF,MAAM,UAAU,MAAM,gIAAE,CAAC,QAAQ,CAAC,UAAU;QAC5C,OAAO,KAAK,KAAK,CAAC;IACpB,EAAE,OAAO,KAAU;QACjB,IAAI,KAAK,SAAS,UAAU;YAC1B,MAAM,UAAsB;gBAAE,QAAQ,EAAE;YAAC;YACzC,MAAM,gIAAE,CAAC,SAAS,CAAC,UAAU,KAAK,SAAS,CAAC,SAAS,MAAM,IAAI;YAC/D,OAAO;QACT;QACA,MAAM;IACR;AACF;AAEA,eAAe,UAAU,KAAiB;IACxC,MAAM,UAAU,KAAK,SAAS,CAAC,OAAO,MAAM;IAC5C,MAAM,gIAAE,CAAC,SAAS,CAAC,aAAa,SAAS;IACzC,MAAM,gIAAE,CAAC,MAAM,CAAC,aAAa;AAC/B;AAEO,eAAe,SAAS,MAM9B;IACC,MAAM,QAAQ,MAAM;IACpB,MAAM,KAAK,IAAA,2JAAM,EAAC;IAClB,MAAM,UAAU,IAAA,2JAAM,EAAC;IACvB,MAAM,SAAsB;QAC1B;QACA,OAAO,OAAO,KAAK;QACnB,WAAW,OAAO,GAAG;QACrB,YAAY,OAAO,GAAG;QACtB,iBAAiB,OAAO,eAAe,IAAI;QAC3C,WAAW,OAAO,SAAS;QAC3B,SAAS,OAAO,OAAO;QACvB;QACA,WAAW;QACX,mBAAmB;QACnB,WAAW,IAAI,OAAO,WAAW;IACnC;IACA,MAAM,MAAM,CAAC,IAAI,CAAC;IAClB,MAAM,UAAU;IAChB,OAAO;AACT;AAEO,eAAe,SAAS,SAAiB;IAC9C,MAAM,QAAQ,MAAM;IACpB,OAAO,MAAM,MAAM,CAAC,IAAI,CAAC,CAAC,IAAM,EAAE,EAAE,KAAK,aAAa,EAAE,OAAO,KAAK;AACtE;AAGO,eAAe;IACpB,MAAM,QAAQ,MAAM;IACpB,OAAO,MAAM,MAAM;AACrB;AAGO,eAAe,YAAY,SAAiB;IACjD,MAAM,QAAQ,MAAM;IACpB,MAAM,QAAQ,MAAM,MAAM,CAAC,SAAS,CAAC,CAAC,IAAM,EAAE,EAAE,KAAK,aAAa,EAAE,OAAO,KAAK;IAChF,IAAI,UAAU,CAAC,GAAG,OAAO;IACzB,MAAM,CAAC,QAAQ,GAAG,MAAM,MAAM,CAAC,MAAM,CAAC,OAAO;IAC7C,MAAM,UAAU;IAChB,OAAO;AACT;AAEO,eAAe,cAAc,EAAU;IAC5C,MAAM,QAAQ,MAAM;IACpB,MAAM,QAAQ,MAAM,MAAM,CAAC,IAAI,CAAC,CAAC,IAAM,EAAE,EAAE,KAAK,MAAM,EAAE,OAAO,KAAK;IACpE,IAAI,OAAO;QACT,MAAM,SAAS,IAAI;QACnB,MAAM,UAAU;IAClB;IACA,OAAO;AACT;AAEO,eAAe,iBAAiB,EAAU,EAAE,iBAAyB;IAC1E,MAAM,QAAQ,MAAM;IACpB,MAAM,QAAQ,MAAM,MAAM,CAAC,IAAI,CAAC,CAAC,IAAM,EAAE,EAAE,KAAK,MAAM,EAAE,OAAO,KAAK;IACpE,IAAI,OAAO;QACT,MAAM,iBAAiB,GAAG,KAAK,GAAG,CAAC,MAAM,iBAAiB,EAAE;QAC5D,MAAM,UAAU;IAClB;IACA,OAAO;AACT"}},
    {"offset": {"line": 169, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/rohit/OneDrive/Desktop/shareable-screen-studio/app/api/upload/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { S3Client, PutObjectCommand } from \"@aws-sdk/client-s3\";\r\nimport path from \"path\";\r\nimport fs from \"fs/promises\";\r\nimport { addVideo } from \"@/lib/db\";\r\nimport { nanoid } from \"nanoid\";\r\n\r\nexport const runtime = 'nodejs';\r\n\r\nconst hasS3Config =\r\n  !!process.env.S3_BUCKET &&\r\n  !!process.env.AWS_REGION &&\r\n  !!process.env.AWS_ACCESS_KEY_ID &&\r\n  !!process.env.AWS_SECRET_ACCESS_KEY;\r\n\r\nconst s3Client = hasS3Config\r\n  ? new S3Client({\r\n      region: process.env.S3_REGION || process.env.AWS_REGION,\r\n      endpoint: process.env.S3_ENDPOINT,\r\n    })\r\n  : null;\r\n\r\nasync function uploadToS3(file: File, key: string) {\r\n  if (!s3Client || !process.env.S3_BUCKET) return null;\r\n  \r\n  try {\r\n    const arrayBuffer = await file.arrayBuffer();\r\n    \r\n    // Prepare S3 parameters - remove ACL as it's deprecated in newer S3 versions\r\n    const params: any = {\r\n      Bucket: process.env.S3_BUCKET,\r\n      Key: key,\r\n      Body: Buffer.from(arrayBuffer),\r\n      ContentType: file.type || \"video/webm\",\r\n    };\r\n\r\n    // Only add ACL if explicitly configured (for older S3 setups)\r\n    if (process.env.S3_USE_ACL === 'true') {\r\n      params.ACL = \"public-read\";\r\n    }\r\n\r\n    await s3Client.send(new PutObjectCommand(params));\r\n    \r\n    // Generate the public URL\r\n    const endpoint = process.env.S3_PUBLIC_URL || `https://${process.env.S3_BUCKET}.s3.${process.env.AWS_REGION}.amazonaws.com`;\r\n    const publicUrl = `${endpoint}/${key}`;\r\n    \r\n    console.log('S3 upload successful:', { key, size: file.size, url: publicUrl });\r\n    return publicUrl;\r\n  } catch (error) {\r\n    console.error('S3 upload error:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\nasync function uploadToLocal(file: File, key: string) {\r\n  const uploadsDir = path.join(process.cwd(), \"public\", \"uploads\");\r\n  await fs.mkdir(uploadsDir, { recursive: true });\r\n  const arrayBuffer = await file.arrayBuffer();\r\n  const filePath = path.join(uploadsDir, key);\r\n  await fs.writeFile(filePath, Buffer.from(arrayBuffer));\r\n  return `/uploads/${key}`;\r\n}\r\n\r\nexport async function POST(request: Request) {\r\n  try {\r\n    const origin = new URL(request.url).origin;\r\n    const formData = await request.formData();\r\n    const file = formData.get(\"file\") as File | null;\r\n    const title = (formData.get(\"title\") as string | null) || \"Recording\";\r\n    const duration = Number(formData.get(\"duration\")) || undefined;\r\n    const trimStart = formData.get(\"trimStart\");\r\n    const trimEnd = formData.get(\"trimEnd\");\r\n\r\n    if (!file) {\r\n      console.error('Upload error: No file provided');\r\n      return NextResponse.json({ error: \"Missing file\" }, { status: 400 });\r\n    }\r\n\r\n    console.log('Upload request:', { \r\n      fileName: file.name, \r\n      fileSize: file.size, \r\n      fileType: file.type, \r\n      title, \r\n      duration \r\n    });\r\n\r\n    const safeName = (file.name || \"recording.webm\").replace(/[^a-zA-Z0-9\\\\.\\\\-]/g, \"-\");\r\n    const key = `${nanoid(8)}-${safeName}`;\r\n\r\n    let url: string;\r\n    try {\r\n      if (hasS3Config) {\r\n        console.log('Attempting S3 upload...');\r\n        url = await uploadToS3(file, key);\r\n        if (!url) {\r\n          throw new Error('S3 upload returned null');\r\n        }\r\n        console.log('S3 upload successful:', url);\r\n      } else {\r\n        console.log('Using local storage...');\r\n        url = await uploadToLocal(file, key);\r\n        console.log('Local upload successful:', url);\r\n      }\r\n    } catch (uploadError) {\r\n      console.error('Upload failed:', uploadError);\r\n      // Try local fallback if S3 fails\r\n      if (hasS3Config) {\r\n        console.log('S3 failed, trying local fallback...');\r\n        url = await uploadToLocal(file, key);\r\n        console.log('Local fallback successful:', url);\r\n      } else {\r\n        throw uploadError;\r\n      }\r\n    }\r\n\r\n    if (!url) {\r\n      console.error('Upload failed: No URL generated');\r\n      return NextResponse.json({ error: \"Failed to store file\" }, { status: 500 });\r\n    }\r\n\r\n    const video = await addVideo({\r\n      title,\r\n      url: url.startsWith(\"http\") ? url : `${origin}${url}`,\r\n      durationSeconds: duration,\r\n      trimStart: trimStart ? Number(trimStart) : undefined,\r\n      trimEnd: trimEnd ? Number(trimEnd) : undefined,\r\n    });\r\n\r\n    const shareUrl = `${origin}/watch/${video.shareId}`;\r\n    console.log('Video record created:', { videoId: video.id, shareUrl });\r\n\r\n    return NextResponse.json({ video, shareUrl });\r\n  } catch (error) {\r\n    console.error(\"Upload error:\", error);\r\n    const errorMessage = error instanceof Error ? error.message : \"Upload failed\";\r\n    return NextResponse.json({ error: errorMessage }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}